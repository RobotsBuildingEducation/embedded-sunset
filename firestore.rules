rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {

      // Allow read access if the document's npub field matches the document ID (userId).
      allow read: if resource.data.npub == userId;

      // Allow create access if the document's npub field matches the document ID (userId).
      allow create: if request.resource.data.npub == userId;

      // Allow update access if:
      // 1. The request includes an `npub` field that matches the document ID.
      // 2. The existing document's `npub` matches the document ID.
      allow update: if request.resource.data.npub == userId 
                    && resource.data.npub == userId;

      // Deny listing (query) access to the entire collection.
      allow list: if false;
    }
  }
}
